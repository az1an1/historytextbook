<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mughal Empire Timeline & Quiz</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load a traditional-looking font (Tinos is a good serif option) -->
    <link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <!-- Firebase Imports (Required for the environment) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global Firebase variables required by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        setLogLevel('Debug');

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            // Authentication: Sign in with token if available, otherwise anonymously
            if (initialAuthToken) {
                signInWithCustomToken(window.auth, initialAuthToken)
                    .then(userCredential => {
                        console.log("Firebase signed in with custom token.", userCredential.user.uid);
                    })
                    .catch(error => {
                        console.error("Firebase Custom Token sign-in failed:", error);
                        signInAnonymously(window.auth).then(() => console.log("Signed in anonymously (fallback)."));
                    });
            } else {
                signInAnonymously(window.auth).then(() => console.log("Signed in anonymously."));
            }
        } catch(e) {
            console.error("Firebase Initialization failed:", e);
        }
    </script>
    <style>
        /* Custom CSS for the old-world South Asian theme */
        body {
            font-family: 'Tinos', serif;
            background-color: #5d4037; /* Dark brown background */
            line-height: 1.7;
        }

        .parchment-bg {
            /* Simulates an aged paper look */
            background-color: #f5f5dc; /* Beige/Cream */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border: 10px solid #a1887f; /* Ornate border color */
            /* Using a simple border for compatibility */
            border-style: ridge;
        }

        .title-ornate {
            /* Deep red and gold title styling */
            color: #880e4f; /* Deep Maroon */
            border-bottom: 3px double #d4af37; /* Gold separator */
        }

        .timeline-container {
            /* Custom line for the timeline */
            border-left: 3px solid #795548; /* Brown vertical line */
            padding-left: 2rem;
            position: relative;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 3rem;
        }

        .timeline-item::before {
            /* Ornate circle/dot on the timeline line */
            content: '';
            position: absolute;
            left: -2.35rem; /* Adjust to align with the line */
            top: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            background-color: #d4af37; /* Gold circle */
            border: 3px solid #795548;
            border-radius: 50%;
            z-index: 10;
        }

        /* Responsive Navbar */
        .sticky-navbar {
            z-index: 50;
            /* Allow wrapping on smaller screens */
            display: flex;
            flex-wrap: wrap;
        }
        .sticky-navbar a {
            flex-shrink: 0; /* Prevent shrinking */
        }
        @media (max-width: 768px) {
            .sticky-navbar a {
                padding: 0.5rem 0.75rem; /* Smaller padding on mobile */
                font-size: 0.75rem; /* Smaller font on mobile */
                margin: 0.25rem; /* Small margin between buttons */
            }
        }

        /* Quiz Button Styling */
        .quiz-button {
            background-color: #d4af37; /* Gold */
            color: #5d4037; /* Brown text */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .quiz-button:hover {
            background-color: #f7d342;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .quiz-option:hover {
            background-color: #fce8a6;
        }
        .quiz-option.selected {
            border-color: #d4af37;
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Sticky Navigation Bar (Emperors and Quiz) -->
    <nav class="sticky-navbar top-0 w-full bg-[#795548] bg-opacity-95 shadow-lg p-2 md:p-3 rounded-lg justify-center space-x-1 md:space-x-4 mb-8">
        <a href="#timeline-view" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Timeline View</a>
        <a href="#babar" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Babar</a>
        <a href="#humayun" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Humayun</a>
        <a href="#akbar" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Akbar</a>
        <a href="#jahangir" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Jahangir</a>
        <a href="#shahjahan" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Shah Jahan</a>
        <a href="#aurangzeb" class="text-white hover:bg-yellow-600 transition duration-300 py-1 px-3 md:py-2 md:px-4 rounded-md font-bold text-sm md:text-base bg-[#880e4f]">Aurangzeb</a>
        <a href="#quiz-setup" id="quiz-nav-button" class="quiz-button py-1 px-3 md:py-2 md:px-4 rounded-md font-extrabold text-sm md:text-base">Take a Quiz!</a>
    </nav>
    
    <!-- Main Parchment Container -->
    <main class="parchment-bg max-w-4xl mx-auto p-6 md:p-10 rounded-xl">
        
        <!-- View Container: Manages visibility of Timeline vs Quiz -->
        <div id="view-container">
            
            <!-- Timeline View -->
            <section id="timeline-view">
                <header class="text-center mb-10">
                    <h1 class="text-3xl md:text-5xl font-extrabold title-ornate pb-4">The Grand Saga of the Mughal Empire</h1>
                    <p class="text-xl text-stone-700 italic mt-4">A Chronicle of the Six Great Emperors (1526–1707)</p>
                </header>

                <!-- Timeline Content Area -->
                <div class="timeline-container">
                    
                    <!-- 1. Babar (1526-1530) -->
                    <section id="babar" class="timeline-item">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[#880e4f]">Zahir-ud-din Muhammad Babar (1526–1530)</h2>
                        <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner">
                            <p class="font-bold text-lg text-stone-700 mb-2">The Founder of the Lineage</p>
                            <ul class="list-disc ml-6 text-stone-800 space-y-2">
                                <li><span class="font-semibold text-red-900">1494:</span> Inherited the throne of Fergana (modern Uzbekistan) at age 11.</li>
                                <li><span class="font-semibold text-red-900">1504:</span> Captured Kabul, establishing a power base for Indian campaigns.</li>
                                <li><span class="font-semibold text-red-900">1526:</span> Defeated Ibrahim Lodi at the **First Battle of Panipat**, using superior field artillery and tactics, marking the establishment of the Mughal Dynasty in India.</li>
                                <li><span class="font-semibold text-red-900">1527:</span> Defeated the powerful Rajput confederacy led by Rana Sanga at the Battle of Khanwa, securing his rule.</li>
                                <li><span class="font-semibold text-red-900">1529:</span> Defeated the Afghan chieftains at the Battle of Ghaghra.</li>
                                <li>Known for his autobiography, the <span class="italic">Tuzk-e-Babri</span> (Baburnama), providing a vivid account of his life and the subcontinent.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- 2. Humayun (1530–1540, 1555–1556) -->
                    <section id="humayun" class="timeline-item">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[#880e4f]">Nasir-ud-din Muhammad Humayun (1530–1556)</h2>
                        <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner">
                            <p class="font-bold text-lg text-stone-700 mb-2">The Exiled & Restored Ruler</p>
                            <ul class="list-disc ml-6 text-stone-800 space-y-2">
                                <li><span class="font-semibold text-red-900">1539:</span> Defeated by Sher Shah Suri at the Battle of Chausa.</li>
                                <li><span class="font-semibold text-red-900">1540:</span> Lost the empire to Sher Shah Suri after the Battle of Kannauj, leading to 15 years of exile in Safavid Persia.</li>
                                <li>During exile, developed a deep appreciation for Persian art and culture, which later influenced Mughal style.</li>
                                <li><span class="font-semibold text-red-900">1555:</span> Regained control of the throne after defeating Sikandar Shah Suri at the Battle of Sirhind.</li>
                                <li><span class="font-semibold text-red-900">1556:</span> Died just six months after regaining his empire, falling down the stairs of his library, the Sher Mandal.</li>
                                <li>His tomb, Humayun's Tomb, is a masterpiece of early Mughal architecture and a precursor to the Taj Mahal.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- 3. Akbar (1556–1605) -->
                    <section id="akbar" class="timeline-item">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[#880e4f]">Jalal-ud-din Muhammad Akbar (1556–1605)</h2>
                        <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner">
                            <p class="font-bold text-lg text-stone-700 mb-2">The Architect of the Empire (Akbar The Great)</p>
                            <ul class="list-disc ml-6 text-stone-800 space-y-2">
                                <li><span class="font-semibold text-red-900">1556:</span> Secured the throne at age 13 after defeating the army of Hemu at the **Second Battle of Panipat**.</li>
                                <li><span class="font-semibold text-red-900">1564:</span> Abolished the discriminatory Jizya tax on non-Muslims, initiating a policy of religious tolerance.</li>
                                <li><span class="font-semibold text-red-900">1571:</span> Founded the new capital city of Fatehpur Sikri.</li>
                                <li><span class="font-semibold text-red-900">1575:</span> Established the **Ibadat Khana** (House of Worship) to debate religious doctrines.</li>
                                <li>Implemented the highly effective **Mansabdari System** for administration and military organization.</li>
                                <li>Patronized arts and literature, overseeing a significant expansion of the empire's territory through conquest and diplomacy.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- 4. Jahangir (1605–1627) -->
                    <section id="jahangir" class="timeline-item">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[#880e4f]">Nur-ud-din Muhammad Salim Jahangir (1605–1627)</h2>
                        <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner">
                            <p class="font-bold text-lg text-stone-700 mb-2">The Connoisseur of Art</p>
                            <ul class="list-disc ml-6 text-stone-800 space-y-2">
                                <li><span class="font-semibold text-red-900">1605:</span> Established the **Chain of Justice** outside his fort in Agra, allowing the common man direct appeal.</li>
                                <li><span class="font-semibold text-red-900">1611:</span> Married Mehr-un-Nissa, who was renamed **Nur Jahan** ("Light of the World"), who became the most powerful woman in the empire.</li>
                                <li>The reign saw the pinnacle of **Mughal Miniature Painting**, with a focus on naturalism and portraiture.</li>
                                <li><span class="font-semibold text-red-900">1615:</span> Received Sir Thomas Roe, the ambassador of King James I of England, granting trading rights to the English East India Company.</li>
                                <li>Known for his autobiography, the <span class="italic">Tuzk-e-Jahangiri</span>.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- 5. Shah Jahan (1628–1658) -->
                    <section id="shahjahan" class="timeline-item">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[#880e4f]">Shahab-ud-din Muhammad Khurram Shah Jahan (1628–1658)</h2>
                        <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner">
                            <p class="font-bold text-lg text-stone-700 mb-2">The Golden Age of Architecture</p>
                            <ul class="list-disc ml-6 text-stone-800 space-y-2">
                                <li><span class="font-semibold text-red-900">1631:</span> Began construction of the **Taj Mahal** in Agra after the death of his beloved wife, Mumtaz Mahal (completed c. 1648).</li>
                                <li><span class="font-semibold text-red-900">1638:</span> Shifted the capital from Agra to the newly built **Shahjahanabad** (Old Delhi).</li>
                                <li>Built the **Red Fort** (<span class="italic">Lal Qila</span>) and the **Jama Masjid** in Delhi, showcasing his passion for white marble and red sandstone.</li>
                                <li>Commissioned the famous **Peacock Throne** (<span class="italic">Takht-e-Taus</span>), which took seven years to complete.</li>
                                <li><span class="font-semibold text-red-900">1658:</span> Imprisoned by his son Aurangzeb after a severe illness, spending his final years in the Agra Fort.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- 6. Aurangzeb (1658–1707) -->
                    <section id="aurangzeb" class="timeline-item">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-[#880e4f]">Muhi-ud-din Muhammad Aurangzeb (1658–1707)</h2>
                        <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner">
                            <p class="font-bold text-lg text-stone-700 mb-2">The Final Great Emperor</p>
                            <ul class="list-disc ml-6 text-stone-800 space-y-2">
                                <li><span class="font-semibold text-red-900">1658:</span> Defeated and imprisoned his father Shah Jahan after winning the War of Succession against his brothers (Dara Shikoh, Shuja, and Murad Baksh).</li>
                                <li><span class="font-semibold text-red-900">1679:</span> Reimposed the Jizya tax, reversing Akbar's secular policies.</li>
                                <li>His policies led to increasing tensions with the Sikhs, Marathas (under Shivaji), and Rajputs.</li>
                                <li>Expanded the empire to its **largest territorial extent** through conquest, conquering the Deccan Sultanates of Bijapur (1686) and Golconda (1687).</li>
                                <li><span class="font-semibold text-red-900">1707:</span> Died at Ahmednagar, his long rule depleting the imperial treasury and leading to immediate decentralization.</li>
                            </ul>
                        </div>
                    </section>

                    <!-- Conclusion/End Marker -->
                    <div class="mt-12 pt-6 border-t-2 border-stone-400 text-center text-stone-700 italic">
                        <p>The Mughal Empire continued for another century and a half, but the passing of Aurangzeb marks the close of the period of the great central authority.</p>
                    </div>
                </div>
            </section>
            
            <!-- Quiz Setup and Active Quiz View -->
            <section id="quiz-setup" class="hidden">
                <header class="text-center mb-10">
                    <h1 class="text-3xl md:text-5xl font-extrabold title-ornate pb-4">Test Your Knowledge & Explore</h1>
                    <p class="text-xl text-stone-700 italic mt-4">Select an option below to either take a quiz or generate a random fact.</p>
                </header>

                <div class="max-w-xl mx-auto space-y-8">
                    
                    <!-- 1. Difficulty Selection -->
                    <div class="p-6 border border-stone-300 rounded-lg bg-white shadow-lg">
                        <h2 class="text-2xl font-bold text-[#880e4f] mb-4">1. Generate a Quiz</h2>
                        
                        <div class="mb-6">
                            <p class="text-lg font-semibold text-stone-700 mb-2">Choose Difficulty:</p>
                            <div id="difficulty-options" class="flex justify-around space-x-2">
                                <button data-difficulty="Easy" class="quiz-option p-3 rounded-lg text-stone-800 bg-yellow-100 flex-1 border-2 border-transparent">Easy</button>
                                <button data-difficulty="Medium" class="quiz-option p-3 rounded-lg text-stone-800 bg-yellow-100 flex-1 border-2 border-transparent">Medium</button>
                                <button data-difficulty="Hard" class="quiz-option p-3 rounded-lg text-stone-800 bg-yellow-100 flex-1 border-2 border-transparent">Hard</button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <p class="text-lg font-semibold text-stone-700 mb-2">Choose Topic (Ruler):</p>
                            <select id="topic-select" class="w-full p-3 border-2 border-stone-300 rounded-lg text-lg bg-yellow-50 focus:ring-[#d4af37] focus:border-[#d4af37]">
                                <option value="Mughal Empire">Mughal Empire (All Rulers)</option>
                                <option value="Babar">Zahir-ud-din Muhammad Babar</option>
                                <option value="Humayun">Nasir-ud-din Muhammad Humayun</option>
                                <option value="Akbar">Jalal-ud-din Muhammad Akbar</option>
                                <option value="Jahangir">Nur-ud-din Muhammad Salim Jahangir</option>
                                <option value="Shah Jahan">Shahab-ud-din Muhammad Khurram Shah Jahan</option>
                                <option value="Aurangzeb">Muhi-ud-din Muhammad Aurangzeb</option>
                            </select>
                        </div>
                        
                        <!-- Start Button and Loading -->
                        <div class="text-center">
                            <button id="start-quiz-btn" class="quiz-button w-full py-4 text-xl font-extrabold rounded-xl" disabled>
                                Start Quiz
                            </button>
                            <p id="loading-indicator" class="mt-4 text-stone-700 hidden">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 inline-block text-[#d4af37]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating quiz questions...
                            </p>
                        </div>
                    </div>

                    <!-- 2. Fact Generator Section -->
                    <div class="p-6 border border-stone-300 rounded-lg bg-white shadow-lg">
                        <h2 class="text-2xl font-bold text-[#880e4f] mb-4">2. Generate a Random Fact</h2>
                        <div class="mb-4">
                            <p class="text-lg font-semibold text-stone-700 mb-2">Choose Topic:</p>
                            <select id="fact-topic-select" class="w-full p-3 border-2 border-stone-300 rounded-lg text-lg bg-yellow-50 focus:ring-[#d4af37] focus:border-[#d4af37]">
                                <option value="Mughal Empire">Mughal Empire (Broader Fact)</option>
                                <option value="Babar">Zahir-ud-din Muhammad Babar</option>
                                <option value="Humayun">Nasir-ud-din Muhammad Humayun</option>
                                <option value="Akbar">Jalal-ud-din Muhammad Akbar</option>
                                <option value="Jahangir">Nur-ud-din Muhammad Salim Jahangir</option>
                                <option value="Shah Jahan">Shahab-ud-din Muhammad Khurram Shah Jahan</option>
                                <option value="Aurangzeb">Muhi-ud-din Muhammad Aurangzeb</option>
                            </select>
                        </div>
                        
                        <button id="generate-fact-btn" class="quiz-button w-full py-3 text-lg font-bold mt-2">
                            Generate Fact
                        </button>
                        
                        <p id="fact-loading-indicator" class="mt-4 text-stone-700 hidden text-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 inline-block text-[#d4af37]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Searching history for an interesting fact...
                        </p>
                        
                        <div id="fact-result-area" class="mt-4 p-3 bg-yellow-50 border-l-4 border-[#d4af37] rounded-lg hidden">
                            <p class="font-bold text-stone-800 mb-1">Fact:</p>
                            <p id="fact-text" class="text-stone-700"></p>
                            <p id="fact-sources" class="text-xs italic mt-2 text-stone-600"></p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Active Quiz Area -->
            <div id="quiz-area" class="hidden max-w-2xl mx-auto p-6 border border-stone-300 rounded-lg bg-white shadow-lg space-y-6">
                <!-- Quiz questions and results will be rendered here by JS -->
            </div>
        </div>
    </main>

    <script>
        // --- Global State and Constants ---
        // Base endpoint for the Gemini API call
        const GEMINI_API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // IMPORTANT for GitHub deployment: 
        // JavaScript on a static page cannot directly access GitHub secrets. 
        // You MUST use a build step (like a GitHub Action) to replace this empty string 
        // with the value of your GEMINI_API_KEY secret before deployment.
        // Example: const apiKey = "${{ secrets.GEMINI_API_KEY }}"; (inside the build script)
        const apiKey = ""; 
        const MAX_RETRIES = 5;
        
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedDifficulty = null;
        let isProcessing = false;
        let isFactGenerating = false;

        // --- DOM Elements ---
        const timelineView = document.getElementById('timeline-view');
        const quizSetupView = document.getElementById('quiz-setup');
        const quizArea = document.getElementById('quiz-area');
        const difficultyOptions = document.getElementById('difficulty-options');
        const topicSelect = document.getElementById('topic-select');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Fact Generator Elements
        const factTopicSelect = document.getElementById('fact-topic-select');
        const generateFactBtn = document.getElementById('generate-fact-btn');
        const factLoadingIndicator = document.getElementById('fact-loading-indicator');
        const factResultArea = document.getElementById('fact-result-area');
        const factText = document.getElementById('fact-text');
        const factSources = document.getElementById('fact-sources');

        // --- Utility Functions ---

        // Exponential backoff retry logic for API calls
        async function fetchWithExponentialBackoff(options, maxRetries = 5) {
            const url = `${GEMINI_API_BASE_URL}?key=${apiKey}`; 
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    // Handle 403/429/400 for retry
                    if ((response.status === 403 || response.status === 429 || response.status === 400) && i < maxRetries - 1) { 
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    console.error(`Attempt ${i + 1} failed with status: ${response.status} and message: ${await response.text()}`);
                    throw new Error(`API request failed with status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error(`Final API request failure after ${maxRetries} retries.`, error);
                        throw error;
                    }
                }
            }
        }

        // Switches between the timeline and quiz view
        function setView(viewId) {
            timelineView.classList.add('hidden');
            quizSetupView.classList.add('hidden');
            quizArea.classList.add('hidden');

            if (viewId === 'timeline') {
                timelineView.classList.remove('hidden');
            } else if (viewId === 'quiz-setup') {
                quizSetupView.classList.remove('hidden');
            } else if (viewId === 'quiz-active') {
                quizArea.classList.remove('hidden');
            }
        }

        // --- Quiz Generation Logic ---

        async function generateQuiz(topic, difficulty) {
            if (isProcessing) return;
            isProcessing = true;
            startQuizBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            quizArea.innerHTML = '';
            setView('quiz-active');

            const systemInstruction = `You are a historical quiz generator. Create exactly 5 multiple-choice questions (MCQs) about the Mughal Emperor(s). The output MUST be a JSON array of objects.
                Each question object must have:
                1. 'question': The question text.
                2. 'options': An array of 4 strings for the choices.
                3. 'correctAnswer': The exact text of the correct option.
                4. 'explanation': A brief, concise explanation (1-2 sentences) for the answer.
                The questions must match the difficulty level: ${difficulty}.`;

            const userQuery = `Generate 5 multiple-choice questions on the topic: ${topic}. The questions should be relevant to the ${difficulty} difficulty level.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Removed tools: [{ "google_search": {} }] to allow structured JSON output
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "correctAnswer": { "type": "STRING" },
                                "explanation": { "type": "STRING" }
                            },
                            required: ["question", "options", "correctAnswer", "explanation"]
                        }
                    }
                },
            };
            
            try {
                const responseJson = await fetchWithExponentialBackoff({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const jsonText = responseJson.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("API response was empty or malformed.");
                }
                
                currentQuiz = JSON.parse(jsonText);
                currentQuestionIndex = 0;
                score = 0;
                renderQuestion();

            } catch (error) {
                console.error("Error generating quiz:", error);
                quizArea.innerHTML = `
                    <div class="p-6 text-center text-red-700 bg-red-100 border border-red-400 rounded-lg">
                        <p class="font-bold">Failed to generate quiz.</p>
                        <p class="text-sm mt-2">API Error: ${error.message}. Please check your topic and try again.</p>
                        <button onclick="setView('quiz-setup')" class="mt-4 quiz-button py-2 px-4">Go Back to Setup</button>
                    </div>
                `;
            } finally {
                isProcessing = false;
                loadingIndicator.classList.add('hidden');
                startQuizBtn.disabled = !selectedDifficulty;
            }
        }
        
        // --- Fact Generation Logic ---
        async function generateFact() {
            if (isFactGenerating) return;
            isFactGenerating = true;
            generateFactBtn.disabled = true;
            factResultArea.classList.add('hidden');
            factLoadingIndicator.classList.remove('hidden');

            const topic = factTopicSelect.value;

            const systemInstruction = `You are a concise historical expert. Your task is to provide one single, random, interesting, and well-researched historical fact about the requested topic. The response must be a single paragraph of text only.`;
            const userQuery = `Generate one random, verifiable fact about the topic: ${topic}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // This remains for fact grounding
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };
            
            try {
                const responseJson = await fetchWithExponentialBackoff({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = responseJson.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("Fact generation failed to return text.");
                }

                // Extract sources
                let sourcesHtml = '';
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                    
                    if (sources.length > 0) {
                        // Filter for unique URIs to clean up the display
                        const uniqueSources = Array.from(new Set(sources.map(s => s.uri)))
                            .map(uri => sources.find(s => s.uri === uri));

                        sourcesHtml = 'Sources: ' + uniqueSources.map(s => 
                            `<a href="${s.uri}" target="_blank" class="text-blue-600 hover:underline">${s.title}</a>`
                        ).join(' | ');
                    }
                }

                factText.textContent = text;
                factSources.innerHTML = sourcesHtml;
                factResultArea.classList.remove('hidden');

            } catch (error) {
                console.error("Error generating fact:", error);
                factText.textContent = `Sorry, I couldn't generate a fact right now due to an API error: ${error.message}. Please try again later.`;
                factSources.innerHTML = '';
                factResultArea.classList.remove('hidden');
            } finally {
                isFactGenerating = false;
                generateFactBtn.disabled = false;
                factLoadingIndicator.classList.add('hidden');
            }
        }


        // --- Quiz Rendering and Interaction Logic ---

        function renderQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                renderResults();
                return;
            }

            const q = currentQuiz[currentQuestionIndex];
            const isLastQuestion = currentQuestionIndex === currentQuiz.length - 1;

            quizArea.innerHTML = `
                <h2 class="text-xl md:text-2xl font-bold text-[#880e4f] mb-4">Question ${currentQuestionIndex + 1} of ${currentQuiz.length}</h2>
                <div class="p-4 bg-yellow-900/10 rounded-lg shadow-inner mb-6">
                    <p class="text-lg font-semibold text-stone-800">${q.question}</p>
                </div>
                <div id="options-container" class="space-y-3">
                    ${q.options.map((option, index) => `
                        <button 
                            class="quiz-option w-full text-left p-3 rounded-lg bg-yellow-50 text-stone-700 border-2 border-transparent transition duration-200"
                            data-option="${option.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                            onclick="handleAnswer(this, '${q.correctAnswer.replace(/'/g, "\\'")}', '${q.explanation.replace(/'/g, "\\'")}')"
                            >
                            ${String.fromCharCode(65 + index)}. ${option}
                        </button>
                    `).join('')}
                </div>
                <div id="feedback-area" class="mt-6 p-4 bg-gray-100 border-l-4 border-gray-400 rounded hidden"></div>
                <button id="next-btn" class="quiz-button mt-6 w-full py-3 text-lg font-bold" disabled>${isLastQuestion ? 'View Results' : 'Next Question'}</button>
            `;

            document.getElementById('next-btn').addEventListener('click', () => {
                currentQuestionIndex++;
                renderQuestion();
            });
        }

        function handleAnswer(selectedButton, correctAnswer, explanation) {
            const optionsContainer = document.getElementById('options-container');
            const feedbackArea = document.getElementById('feedback-area');
            const nextBtn = document.getElementById('next-btn');
            
            // Disable all options after selection
            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('quiz-option:hover'); // Remove hover effect
                btn.onclick = null; // Remove handler
            });

            const isCorrect = selectedButton.dataset.option.replace(/&#39;/g, "'").replace(/&quot;/g, '"') === correctAnswer;

            // Highlight the selected option
            selectedButton.classList.remove('bg-yellow-50');
            selectedButton.classList.add('selected'); // Adds the border styling
            
            if (isCorrect) {
                score++;
                selectedButton.classList.add('bg-green-200', 'border-green-600');
                feedbackArea.innerHTML = `<p class="font-bold text-green-700">Correct!</p><p class="text-sm">${explanation}</p>`;
                feedbackArea.classList.remove('border-gray-400');
                feedbackArea.classList.add('border-green-600');
            } else {
                selectedButton.classList.add('bg-red-200', 'border-red-600');
                // Find and highlight the correct answer
                Array.from(optionsContainer.children).find(btn => btn.dataset.option.replace(/&#39;/g, "'").replace(/&quot;/g, '"') === correctAnswer).classList.add('bg-green-300', 'border-green-600');
                feedbackArea.innerHTML = `<p class="font-bold text-red-700">Incorrect. The correct answer was: ${correctAnswer}.</p><p class="text-sm">${explanation}</p>`;
                feedbackArea.classList.remove('border-gray-400');
                feedbackArea.classList.add('border-red-600');
            }

            feedbackArea.classList.remove('hidden');
            nextBtn.disabled = false;
        }

        function renderResults() {
            const percentage = ((score / currentQuiz.length) * 100).toFixed(0);
            const message = score === currentQuiz.length ? 'Outstanding! You are a true Mughal historian!' : 
                            score >= currentQuiz.length / 2 ? 'Well done! A solid grasp of the material.' :
                            'Keep studying! Review the timeline to improve your score.';

            quizArea.innerHTML = `
                <div class="text-center p-8 space-y-4 bg-green-50 rounded-lg">
                    <h2 class="text-3xl font-bold text-[#880e4f]">Quiz Completed!</h2>
                    <p class="text-2xl text-stone-800">Your Score: <span class="font-extrabold text-green-600">${score} / ${currentQuiz.length}</span></p>
                    <p class="text-4xl font-extrabold text-green-800">${percentage}%</p>
                    <p class="text-lg italic">${message}</p>
                </div>
                <div class="mt-8 flex flex-col space-y-3">
                    <button onclick="setView('quiz-setup')" class="quiz-button py-3 text-lg font-bold">Try Another Quiz</button>
                    <button onclick="setView('timeline'); window.scrollTo({top: 0, behavior: 'smooth'})" class="py-3 text-lg font-bold bg-stone-300 rounded-xl hover:bg-stone-400 transition">Return to Timeline</button>
                </div>
            `;
        }

        // --- Event Listeners and Initialization ---

        // 1. Navbar link handler (including smooth scroll and view switching)
        document.querySelectorAll('.sticky-navbar a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();

                const targetId = this.getAttribute('href').substring(1);
                
                if (targetId === 'quiz-setup') {
                    setView('quiz-setup');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
                
                if (targetId === 'timeline-view') {
                    setView('timeline');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }

                // Default smooth scroll for timeline anchors
                setView('timeline');
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    // Calculate offset to account for sticky navbar
                    const offset = document.querySelector('.sticky-navbar').offsetHeight + 20; 
                    const targetPosition = targetElement.offsetTop - offset;
                    window.scrollTo({ top: targetPosition, behavior: 'smooth' });
                }
            });
        });

        // 2. Difficulty selection handler
        difficultyOptions.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn || isProcessing) return;

            // Clear previous selections
            Array.from(difficultyOptions.children).forEach(child => child.classList.remove('selected'));

            selectedDifficulty = btn.dataset.difficulty;
            btn.classList.add('selected');
            startQuizBtn.disabled = false; // Enable start button once difficulty is selected
        });

        // 3. Start Quiz button handler
        startQuizBtn.addEventListener('click', () => {
            if (selectedDifficulty && topicSelect.value) {
                generateQuiz(topicSelect.value, selectedDifficulty);
            }
        });
        
        // 4. Generate Fact button handler
        generateFactBtn.addEventListener('click', generateFact);

        // Initial view setup
        setView('timeline');
        
        // Expose functions for use in inline onclick handlers
        window.handleAnswer = handleAnswer;
        window.setView = setView; 

    </script>
</body>
</html>
